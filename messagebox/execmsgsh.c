#include <stdio.h>
#include <windows.h>

int main() {
    // WSL 上でコマンド実行
    // objdump -M intel -d messagebox.exe | grep '^ ' | cut -f2 | perl -pe 's/(\w{2})\s+/\\x\1/g'
    // "41 ff d4"(call r12)以降は必要ないシェルコードなので削除する
    char code[] =
        "\x48\x31\xc9\x65\x48\x8b\x41\x60\x48\x8b\x40\x18\x48\x8b\x40\x20\x48\x8b\x04\x01\x48\x8b"
        "\x04\x01\x48\x8b\x58\x20\x49\x89\xd8\x8b\x5b\x3c\x4c\x01\xc3\xb1\x88\x8b\x14\x0b\x4c\x01"
        "\xc2\x4d\x31\xd2\x44\x8b\x52\x1c\x4d\x01\xc2\x4d\x31\xdb\x44\x8b\x5a\x20\x4d\x01\xc3\x4d"
        "\x31\xe4\x44\x8b\x62\x24\x4d\x01\xc4\x48\x31\xc9\x80\xc1\x07\x48\xb8\x4c\x6f\x61\x64\x4c"
        "\x69\x62\x72\x48\x8d\x30\x48\x31\xc0\x48\x31\xc9\x80\xc1\x07\x48\x31\xff\x41\x8b\x3c\x83"
        "\x4c\x01\xc7\x48\x8b\x3f\x48\x39\xfe\x74\x05\x48\xff\xc0\xeb\xe3\x66\x41\x8b\x04\x44\x41"
        "\x8b\x04\x82\x4c\x01\xc0\x49\x89\xc5\x48\x31\xc9\x80\xc1\x07\x48\xb8\x47\x65\x74\x50\x72"
        "\x6f\x63\x41\x48\x8d\x30\x48\x31\xc0\x48\x31\xc9\x80\xc1\x07\x48\x31\xff\x41\x8b\x3c\x83"
        "\x4c\x01\xc7\x48\x8b\x3f\x48\x39\xfe\x74\x05\x48\xff\xc0\xeb\xe3\x66\x41\x8b\x04\x44\x41"
        "\x8b\x04\x82\x4c\x01\xc0\x49\x89\xc6\xb9\x6c\x6c\x00\x00\x51\x48\xb9\x75\x73\x65\x72\x33"
        "\x32\x2e\x64\x51\x48\x89\xe1\x48\x83\xec\x18\x41\xff\xd5\x48\x83\xc4\x18\x48\x83\xc4\x10"
        "\x49\x89\xc7\xb9\x6f\x78\x41\x00\x51\x48\xb9\x4d\x65\x73\x73\x61\x67\x65\x42\x51\x48\x89"
        "\xe2\x4c\x89\xf9\x48\x83\xec\x28\x41\xff\xd6\x48\x83\xc4\x28\x48\x83\xc4\x10\x49\x89\xc4"
        "\x48\x83\xec\x08\x4d\x31\xc9\x49\xb8\x54\x69\x74\x6c\x65\x00\x00\x00\x41\x50\x49\x89\xe0"
        "\x48\xba\x48\x65\x6c\x6c\x6f\x00\x00\x00\x52\x48\x89\xe2\x48\x31\xc9\x41\xff\xd4";
    printf("sizeof(code) = %d\n", sizeof(code));
    DWORD lpflOldProtect;
    // シェルコードが配置されたメモリ領域に実行権限を付与する
    VirtualProtect(code, sizeof(code), PAGE_EXECUTE_READWRITE, &lpflOldProtect);
    (*(void (*)())code)();
    return 0;
}
